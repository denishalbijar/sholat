<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jadwal Sholat & Imsakiyah</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-light: #f8f9fa;
      --text-light: #212529;
      --bg-dark: #212529;
      --text-dark: #f8f9fa;
      --table-border: #198754;
      --highlight: #ffc107;
    }

    body {
      background-color: var(--bg-light);
      color: var(--text-light);
      transition: 0.3s;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background-color: var(--bg-dark);
        color: var(--text-dark);
      }
    }

    .table-responsive {
      max-height: 80vh;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .sticky-header th {
      position: sticky;
      top: 0;
      background: linear-gradient(135deg, #198754, #145c32);
      color: white;
      z-index: 100;
      text-transform: uppercase;
      padding: 12px;
    }

    .highlight-today td {
      background-color: var(--highlight) !important;
      font-weight: bold;
      color: var(--text-light);
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h2 class="text-success text-center">Jadwal Sholat & Imsakiyah</h2>
    <p id="displaySelection" class="text-center fw-bold"></p>
    <div class="row g-3 mt-3">
      <div class="col-6 col-md-3">
        <label for="yearSelect">Tahun :</label>
        <select id="yearSelect" class="form-select"></select>
      </div>
      <div class="col-6 col-md-3">
        <label for="monthSelect">Bulan :</label>
        <select id="monthSelect" class="form-select"></select>
      </div>
      <div class="col-12 col-md-4">
        <label for="citySelect">Pilih Kota :</label>
        <select id="citySelect" class="form-select"></select>
      </div>
      <div class="col-12 col-md-2 d-grid">
        <button id="tampilkan" class="btn btn-success mt-4">Tampilkan</button>
      </div>
    </div>
    <div class="table-responsive mt-3">
      <table class="table table-bordered text-center">
        <thead class="sticky-header">
          <tr>
            <th>Tanggal</th>
            <th>Imsak</th>
            <th>Subuh</th>
            <th>Terbit</th>
            <th>Dhuha</th>
            <th>Dzuhur</th>
            <th>Ashar</th>
            <th>Maghrib</th>
            <th>Isya</th>
          </tr>
        </thead>
        <tbody id="scheduleContainer"></tbody>
      </table>
    </div>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
$(document).ready(async function () {
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1;
    const currentDate = today.getDate();
    const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    let selectedCityId = "1635"; // Default Mojokerto
    let selectedCityName = "Mojokerto";
    let cityData = [];

    for (let year = currentYear; year <= currentYear + 5; year++) {
        $('#yearSelect').append(new Option(year, year));
    }
    months.forEach((name, index) => {
        $('#monthSelect').append(new Option(name, index + 1));
    });
    $('#yearSelect').val(currentYear);
    $('#monthSelect').val(currentMonth);

    try {
        const response = await fetch("https://api.myquran.com/v2/sholat/kota/semua");
        const data = await response.json();
        cityData = data.data;

        cityData.forEach(city => {
            $('#citySelect').append(new Option(city.lokasi, city.id));
        });

        $('#citySelect').select2({ placeholder: "Pilih Kota", allowClear: true });

        // Coba lacak lokasi pengguna
        detectLocation();

    } catch (error) {
        console.error("Gagal mengambil daftar kota:", error);
    }

    $('#tampilkan').click(function () {
        const year = $('#yearSelect').val();
        const month = $('#monthSelect').val();
        const cityId = $('#citySelect').val();
        const cityText = $("#citySelect option:selected").text();
        if (!cityId) return alert("Pilih kota terlebih dahulu");

        fetchSchedule(cityId, year, month, cityText);
    });

    async function fetchSchedule(cityId, year, month, cityText) {
        const monthName = months[month - 1];

        $('#displaySelection').text(`Jadwal Sholat & Imsakiyah untuk ${cityText} dan sekitarnya, Bulan ${monthName} ${year}`);

        try {
            const response = await fetch(`https://api.myquran.com/v2/sholat/jadwal/${cityId}/${year}/${month}`);
            const data = await response.json();
            if (!data.status) throw new Error("Data tidak tersedia");
            displaySchedule(data.data.jadwal);
        } catch (error) {
            alert("Terjadi kesalahan saat mengambil jadwal sholat");
        }
    }

    function displaySchedule(schedule) {
        const today = new Date().getDate();
        const container = $('#scheduleContainer').empty();

        schedule.forEach(day => {
            const dayNumber = parseInt(day.tanggal.match(/\d+/)[0]);
            const isToday = dayNumber === today;

            container.append(`<tr class="${isToday ? 'highlight-today' : ''}">
                <td>${day.tanggal}</td><td>${day.imsak}</td><td>${day.subuh}</td><td>${day.terbit}</td>
                <td>${day.dhuha}</td><td>${day.dzuhur}</td><td>${day.ashar}</td><td>${day.maghrib}</td>
                <td>${day.isya}</td></tr>`);
        });
    }

    function detectLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async function (position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                    const locationData = await response.json();
                    const cityName = locationData.address.city || locationData.address.town || locationData.address.village;

                    const matchedCity = cityData.find(city => city.lokasi.toLowerCase().includes(cityName.toLowerCase()));

                    if (matchedCity) {
                        selectedCityId = matchedCity.id;
                        selectedCityName = matchedCity.lokasi;
                        $('#citySelect').val(selectedCityId).trigger('change');
                        fetchSchedule(selectedCityId, currentYear, currentMonth, selectedCityName);
                    }

                } catch (error) {
                    console.error("Gagal mendapatkan lokasi:", error);
                }
            }, function (error) {
                console.warn("Lokasi tidak bisa didapatkan:", error.message);
            });
        }
    }

    // Update lokasi otomatis setiap 60 detik
    setInterval(detectLocation, 60000);
});

  </script>
</body>
</html>
